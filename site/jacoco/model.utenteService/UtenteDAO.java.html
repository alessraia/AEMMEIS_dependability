<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UtenteDAO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AEMMETSW</a> &gt; <a href="index.source.html" class="el_package">model.utenteService</a> &gt; <span class="el_source">UtenteDAO.java</span></div><h1>UtenteDAO.java</h1><pre class="source lang-java linenums">package model.utenteService;

import model.ConPool;
import model.carrelloService.Carrello;
import model.carrelloService.CarrelloDAO;
import model.carrelloService.RigaCarrelloDAO;
import model.ordineService.OrdineDAO;
import model.tesseraService.TesseraDAO;

import java.sql.*;
import java.util.ArrayList;
import java.util.List;
import java.math.BigInteger;
import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;


public class UtenteDAO {

    private TesseraDAO tesseraDAO;
    private RigaCarrelloDAO rigaCarrelloDAO;
    private CarrelloDAO carrelloDAO;
    private OrdineDAO ordineDAO;

    public UtenteDAO() {
<span class="fc" id="L27">        this(new TesseraDAO(), new RigaCarrelloDAO(), new CarrelloDAO(), new OrdineDAO());</span>
<span class="fc" id="L28">    }</span>

    public UtenteDAO(TesseraDAO tesseraDAO, RigaCarrelloDAO rigaCarrelloDAO, 
<span class="fc" id="L31">                     CarrelloDAO carrelloDAO, OrdineDAO ordineDAO) {</span>
<span class="fc" id="L32">        this.tesseraDAO = tesseraDAO;</span>
<span class="fc" id="L33">        this.rigaCarrelloDAO = rigaCarrelloDAO;</span>
<span class="fc" id="L34">        this.carrelloDAO = carrelloDAO;</span>
<span class="fc" id="L35">        this.ordineDAO = ordineDAO;</span>
<span class="fc" id="L36">    }</span>
    /*@ public behavior
      @   requires email != null &amp;&amp; email.length() &gt; 0;
      @   assignable \nothing;
      @   ensures \result == null
      @        || (\result.getEmail() != null &amp;&amp; \result.getEmail().equals(email) &amp;&amp; \result.getNomeUtente() != null &amp;&amp; \result.getCodiceSicurezza() != null &amp;&amp; \result.getTipo() != null &amp;&amp; \result.getTelefoni() != null);
      @   signals (RuntimeException e) true;
      @*/
    public Utente doRetrieveById(String email) {
<span class="fc" id="L45">        try (Connection con = ConPool.getConnection()) {</span>
<span class="fc" id="L46">            PreparedStatement ps =</span>
<span class="fc" id="L47">                    con.prepareStatement(&quot;SELECT nomeUtente, email, codiceSicurezza, tipo FROM Utente WHERE email=?&quot;);</span>
<span class="fc" id="L48">            ps.setString(1, email);</span>
<span class="fc" id="L49">            ResultSet rs = ps.executeQuery();</span>
<span class="fc bfc" id="L50" title="All 2 branches covered.">            if (rs.next()) {</span>
<span class="fc" id="L51">                Utente p = new Utente();</span>
<span class="fc" id="L52">                p.setNomeUtente(rs.getString(1));</span>
<span class="fc" id="L53">                p.setEmail(rs.getString(2));</span>
<span class="fc" id="L54">                p.setCodiceSicurezzaNoHash(rs.getString(3));</span>
<span class="fc" id="L55">                p.setTipo(rs.getString(4));</span>
<span class="fc" id="L56">                p.setTelefoni(this.cercaTelefoni(p.getEmail()));</span>
<span class="fc" id="L57">                return p;</span>
            }
<span class="fc" id="L59">            return null;</span>
<span class="pc bpc" id="L60" title="1 of 2 branches missed.">        } catch (SQLException e) {</span>
<span class="fc" id="L61">            throw new RuntimeException(e);</span>
        }
    }

    /*@ public behavior
     @   requires email != null &amp;&amp; email.length() &gt; 0
     @         &amp;&amp; password != null &amp;&amp; password.length() &gt; 0;
     @   assignable \nothing;
     @   ensures \result == null
     @        || (\result.getEmail() != null
     @            &amp;&amp; \result.getEmail().equals(email) &amp;&amp; \result.getNomeUtente() != null
     @            &amp;&amp; \result.getCodiceSicurezza() != null &amp;&amp; \result.getTipo() != null &amp;&amp; \result.getTelefoni() != null);
     @   signals (RuntimeException e) true;
     @*/
    public Utente doRetrieveByEmailPassword(String email, String password) {
<span class="fc" id="L76">        try (Connection con = ConPool.getConnection()) {</span>

<span class="fc" id="L78">            PreparedStatement ps =</span>
<span class="fc" id="L79">                    con.prepareStatement(&quot;SELECT nomeUtente, email, codiceSicurezza, tipo FROM Utente WHERE email=? AND  codiceSicurezza=?&quot;);//SHA1(?)</span>
<span class="fc" id="L80">            ps.setString(1, email);</span>
<span class="fc" id="L81">            ps.setString(2, password);</span>
<span class="fc" id="L82">            ResultSet rs = ps.executeQuery();</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">            if (rs.next()) {</span>
<span class="fc" id="L84">                Utente p = new Utente();</span>
<span class="fc" id="L85">                p.setNomeUtente(rs.getString(1));</span>
<span class="fc" id="L86">                p.setEmail(rs.getString(2));</span>
<span class="fc" id="L87">                p.setCodiceSicurezzaNoHash(rs.getString(3));</span>
<span class="fc" id="L88">                p.setTipo(rs.getString(4));</span>
<span class="fc" id="L89">                p.setTelefoni(this.cercaTelefoni(p.getEmail()));</span>
<span class="fc" id="L90">                return p;</span>
            }
<span class="fc" id="L92">            return null;</span>
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">        } catch (SQLException e) {</span>
<span class="fc" id="L94">            throw new RuntimeException(e);</span>
        }
    }


    /*@ public behavior
      @   requires utente != null
      @        &amp;&amp; utente.getEmail() != null
      @        &amp;&amp; utente.getEmail().length() &gt; 0
      @        &amp;&amp; utente.getNomeUtente() != null
      @        &amp;&amp; utente.getEmail() != null &amp;&amp; utente.getEmail().length() &gt; 0
      @        &amp;&amp; utente.getCodiceSicurezza() != null &amp;&amp; utente.getCodiceSicurezza().length() &gt; 0
      @        &amp;&amp; utente.getTipo() != null &amp;&amp; utente.getTipo().length() &gt; 0
      @        &amp;&amp; utente.getTelefoni() != null;
      @   assignable \nothing;
      @   signals (RuntimeException e) true;
      @*/
    public void doSave(Utente utente) {
<span class="fc" id="L112">        try (Connection con = ConPool.getConnection()) {</span>
<span class="fc" id="L113">            PreparedStatement ps = con.prepareStatement(</span>
                    &quot;INSERT INTO Utente (nomeUtente, email, codiceSicurezza, tipo) VALUES(?,?,?,?)&quot;);
<span class="fc" id="L115">            ps.setString(1, utente.getNomeUtente());</span>
<span class="fc" id="L116">            ps.setString(2, utente.getEmail());</span>
<span class="fc" id="L117">            ps.setString(3, utente.getCodiceSicurezza());</span>
<span class="fc" id="L118">            ps.setString(4, utente.getTipo());</span>

<span class="fc bfc" id="L120" title="All 2 branches covered.">            if (ps.executeUpdate() != 1) {</span>
<span class="fc" id="L121">                throw new RuntimeException(&quot;INSERT error.&quot;);</span>
            }

<span class="fc bfc" id="L124" title="All 2 branches covered.">            for(String tel : utente.getTelefoni()){</span>
<span class="fc" id="L125">                this.addTelefono(utente.getEmail(), tel);</span>
<span class="fc" id="L126">            }</span>

<span class="fc" id="L128">        } catch (SQLException e) {</span>
<span class="fc" id="L129">            throw new RuntimeException(e);</span>
<span class="fc" id="L130">        }</span>

<span class="fc" id="L132">    }</span>

    /*@ public behavior
  @   assignable \nothing;
  @   ensures \result != null;
  @   ensures (\forall int i; 0 &lt;= i &amp;&amp; i &lt; \result.size();
  @              \result.get(i) != null
  @           &amp;&amp; \result.get(i).getEmail() != null
  @           &amp;&amp; \result.get(i).getEmail().length() &gt; 0
  @           &amp;&amp; \result.get(i).getNomeUtente() != null
  @           &amp;&amp; \result.get(i).getCodiceSicurezza() != null
  @           &amp;&amp; \result.get(i).getCodiceSicurezza().length() &gt; 0
  @           &amp;&amp; \result.get(i).getTipo() != null
  @           &amp;&amp; \result.get(i).getTipo().length() &gt; 0);
  @   signals (RuntimeException e) true;
  @*/
    public List&lt;Utente&gt; doRetrieveAll() {
<span class="fc" id="L149">        List&lt;Utente&gt; utenti = new ArrayList&lt;Utente&gt;();</span>
<span class="fc" id="L150">        try (Connection con = ConPool.getConnection()) {</span>
<span class="fc" id="L151">            PreparedStatement ps =</span>
<span class="fc" id="L152">                    con.prepareStatement(&quot;SELECT * FROM Utente&quot;);</span>

<span class="fc" id="L154">            ResultSet rs = ps.executeQuery();</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">            while (rs.next()) {</span>
<span class="fc" id="L156">                Utente p = new Utente();</span>
<span class="fc" id="L157">                p.setNomeUtente(rs.getString(1));</span>
<span class="fc" id="L158">                p.setEmail(rs.getString(2));</span>
<span class="fc" id="L159">                p.setCodiceSicurezzaNoHash(rs.getString(3));</span>
<span class="fc" id="L160">                p.setTipo(rs.getString(4));</span>
<span class="fc" id="L161">                utenti.add(p);</span>
<span class="fc" id="L162">            }</span>
<span class="fc" id="L163">            return utenti;</span>
<span class="fc" id="L164">        } catch(SQLException e){</span>
<span class="fc" id="L165">            throw new RuntimeException(e);</span>
        }
    }

    /*@ public behavior
     @   requires utente != null
      @        &amp;&amp; utente.getEmail() != null
      @        &amp;&amp; utente.getEmail().length() &gt; 0
      @        &amp;&amp; utente.getNomeUtente() != null
      @        &amp;&amp; utente.getEmail() != null &amp;&amp; utente.getEmail().length() &gt; 0
      @        &amp;&amp; utente.getCodiceSicurezza() != null &amp;&amp; utente.getCodiceSicurezza().length() &gt; 0
      @        &amp;&amp; utente.getTipo() != null &amp;&amp; utente.getTipo().length() &gt; 0
      @        &amp;&amp; utente.getTelefoni() != null;
     @   assignable \nothing;
     @   signals (RuntimeException e) true;
     @*/
    public void updateUtente(Utente utente){
<span class="fc" id="L182">        try(Connection con = ConPool.getConnection()){</span>
<span class="fc" id="L183">            PreparedStatement ps = con.prepareStatement(&quot;UPDATE Utente SET nomeUtente = ?, tipo = ? WHERE email = ?&quot;);</span>
<span class="fc" id="L184">            ps.setString(1, utente.getNomeUtente());</span>
<span class="fc" id="L185">            ps.setString(2, utente.getTipo());</span>
<span class="fc" id="L186">            ps.setString(3, utente.getEmail());</span>
<span class="fc bfc" id="L187" title="All 2 branches covered.">            if(ps.executeUpdate() != 1)</span>
<span class="fc" id="L188">                throw new RuntimeException(&quot;UPDATE error.&quot;);</span>
<span class="fc" id="L189">            List&lt;String&gt; telefoni = this.cercaTelefoni(utente.getEmail());</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">            for (String tel : utente.getTelefoni() ){</span>
<span class="fc bfc" id="L191" title="All 2 branches covered.">                if(!(telefoni.contains(tel))){</span>
<span class="fc" id="L192">                    this.addTelefono(utente.getEmail(), tel);</span>
                }
<span class="fc" id="L194">            }</span>
<span class="fc bfc" id="L195" title="All 2 branches covered.">            for (String tel : telefoni ){</span>
<span class="pc bpc" id="L196" title="1 of 2 branches missed.">                if(!(utente.getTelefoni().contains(tel))){</span>
<span class="nc" id="L197">                    this.deleteTelefono(utente.getEmail(), tel);</span>
                }
<span class="fc" id="L199">            }</span>

<span class="fc" id="L201">        } catch (SQLException e) {</span>
<span class="fc" id="L202">            throw new RuntimeException(e);</span>
<span class="fc" id="L203">        }</span>
<span class="fc" id="L204">    }</span>

    /*@ public behavior
      @   requires utente != null
      @        &amp;&amp; utente.getEmail() != null
      @        &amp;&amp; utente.getEmail().length() &gt; 0
      @        &amp;&amp; utente.getCodiceSicurezza() != null &amp;&amp; utente.getCodiceSicurezza().length() &gt; 0;
      @   assignable \nothing;
      @   signals (RuntimeException e) true;
      @*/
    public void updateUtentePassword(Utente utente){
<span class="fc" id="L215">        try(Connection con = ConPool.getConnection()){</span>
<span class="fc" id="L216">            PreparedStatement ps = con.prepareStatement(&quot;UPDATE Utente SET codiceSicurezza = ? WHERE email = ?&quot;);</span>
<span class="fc" id="L217">            ps.setString(1, utente.getCodiceSicurezza());</span>
<span class="fc" id="L218">            ps.setString(2, utente.getEmail());</span>
<span class="fc bfc" id="L219" title="All 2 branches covered.">            if(ps.executeUpdate() != 1)</span>
<span class="fc" id="L220">                throw new RuntimeException(&quot;UPDATE error.&quot;);</span>

<span class="fc" id="L222">        } catch (SQLException e) {</span>
<span class="fc" id="L223">            throw new RuntimeException(e);</span>
<span class="fc" id="L224">        }</span>
<span class="fc" id="L225">    }</span>

    /*@ public behavior
      @   requires email != null &amp;&amp; email.length() &gt; 0;
      @   assignable \nothing;
      @   signals (RuntimeException e) true;
      @*/
    public void deleteUtente(String email){

<span class="nc bnc" id="L234" title="All 2 branches missed.">        if(this.doRetrieveById(email).getTipo().equalsIgnoreCase(&quot;premium&quot;)){</span>
<span class="nc" id="L235">            tesseraDAO.deleteTessera(tesseraDAO.doRetrieveByEmail(email).getNumero()); //cancello eventuale tessera</span>
        }
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if(!this.doRetrieveById(email).getTelefoni().isEmpty())</span>
<span class="nc" id="L238">            this.deleteTelefoni(email); //relazione con telefoni</span>

<span class="nc bnc" id="L240" title="All 2 branches missed.">        if(!ordineDAO.doRetrieveByUtente(email).isEmpty())</span>
<span class="nc" id="L241">            ordineDAO.deleteOrdiniByEmail(email);</span>
<span class="nc" id="L242">        Carrello carrello = carrelloDAO.doRetriveByUtente(email);</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">        if(!rigaCarrelloDAO.doRetrieveByIdCarrello(carrello.getIdCarrello()).isEmpty())</span>
<span class="nc" id="L244">            rigaCarrelloDAO.deleteRigheCarrelloByIdCarrello(carrello.getIdCarrello());</span>
<span class="nc" id="L245">        carrelloDAO.deleteCarrello(carrello.getIdCarrello());</span>


<span class="nc" id="L248">        try (Connection con = ConPool.getConnection()) {</span>
<span class="nc" id="L249">            PreparedStatement ps =</span>
<span class="nc" id="L250">                    con.prepareStatement(&quot;DELETE FROM Utente WHERE email=?&quot;);</span>
<span class="nc" id="L251">            ps.setString(1, email);</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">            if(ps.executeUpdate() != 1)</span>
<span class="nc" id="L253">                throw new RuntimeException(&quot;DELETE error.&quot;);</span>

<span class="nc" id="L255">        } catch (SQLException e) {</span>
<span class="nc" id="L256">            throw new RuntimeException(e);</span>
<span class="nc" id="L257">        }</span>
<span class="nc" id="L258">    }</span>

    /*@ public behavior
      @   requires email != null &amp;&amp; email.length() &gt; 0
      @        &amp;&amp; numeroTelefono != null &amp;&amp; numeroTelefono.length() &gt; 0;
      @   assignable \nothing;
      @   signals (RuntimeException e) true;
      @*/
    public void deleteTelefono(String email, String numeroTelefono){
<span class="fc" id="L267">        try (Connection con = ConPool.getConnection()) {</span>
<span class="fc" id="L268">            PreparedStatement ps =</span>
<span class="fc" id="L269">                    con.prepareStatement(&quot;DELETE FROM Telefono WHERE email=? AND numeroTelefono=?&quot;);</span>
<span class="fc" id="L270">            ps.setString(1, email);</span>
<span class="fc" id="L271">            ps.setString(2, numeroTelefono);</span>
<span class="fc bfc" id="L272" title="All 2 branches covered.">            if(ps.executeUpdate() != 1)</span>
<span class="fc" id="L273">                throw new RuntimeException(&quot;DELETE error.&quot;);</span>
<span class="fc" id="L274">        } catch (SQLException e) {</span>
<span class="fc" id="L275">            throw new RuntimeException(e);</span>
<span class="fc" id="L276">        }</span>
<span class="fc" id="L277">    }</span>

    /*@ public behavior
      @   requires email != null &amp;&amp; email.length() &gt; 0;
      @   assignable \nothing;
      @   signals (RuntimeException e) true;
      @*/
    public void deleteTelefoni(String email){
<span class="fc" id="L285">        try (Connection con = ConPool.getConnection()) {</span>
<span class="fc" id="L286">            PreparedStatement ps =</span>
<span class="fc" id="L287">                    con.prepareStatement(&quot;DELETE FROM Telefono WHERE email=?&quot;);//Per farlo funzionare bisogna togliere la safe mode dal db</span>
<span class="fc" id="L288">            ps.setString(1, email);</span>
<span class="fc bfc" id="L289" title="All 2 branches covered.">            if(ps.executeUpdate() &lt; 1)</span>
<span class="fc" id="L290">                throw new RuntimeException(&quot;DELETE error. Email: &quot; + email + &quot; not present in the db&quot;);</span>
<span class="fc" id="L291">        } catch (SQLException e) {</span>
<span class="fc" id="L292">            throw new RuntimeException(e);</span>
<span class="fc" id="L293">        }</span>
<span class="fc" id="L294">    }</span>

    /*@ public behavior
      @   requires email != null &amp;&amp; email.length() &gt; 0
      @        &amp;&amp; numeroTelefono != null &amp;&amp; numeroTelefono.length() == 10;
      @   assignable \nothing;
      @   signals (RuntimeException e) true;
      @*/
    public void addTelefono(String email, String numeroTelefono){
<span class="fc" id="L303">        try (Connection con = ConPool.getConnection()) {</span>
<span class="fc" id="L304">            PreparedStatement ps = con.prepareStatement(</span>
                    &quot;INSERT INTO Telefono (numeroTelefono, email) VALUES(?,?)&quot;);
<span class="fc" id="L306">            ps.setString(1, numeroTelefono);</span>
<span class="fc" id="L307">            ps.setString(2, email);</span>
<span class="fc bfc" id="L308" title="All 2 branches covered.">            if (ps.executeUpdate() != 1) {</span>
<span class="fc" id="L309">                throw new RuntimeException(&quot;INSERT error.&quot;);</span>
            }
<span class="fc" id="L311">        } catch (SQLException e) {</span>
<span class="fc" id="L312">            throw new RuntimeException(e);</span>
<span class="fc" id="L313">        }</span>
<span class="fc" id="L314">    }</span>


//mi serve una funzione che cerchi i numeri di telefono di un utente e li salvi nella lista
//cos√¨ da non perdere l'informazione quando si fa il login.

    /*@ public behavior
  @   requires email != null &amp;&amp; email.length() &gt; 0;
  @   assignable \nothing;
  @   ensures \result != null;
  @   ensures (\forall int i; 0 &lt;= i &amp;&amp; i &lt; \result.size();
  @              \result.get(i) != null
  @           &amp;&amp; \result.get(i).length() == 10);
  @   signals (RuntimeException e) true;
  @*/
    public List&lt;String&gt; cercaTelefoni(String email) {
<span class="fc" id="L330">        List&lt;String&gt; telefoni = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L331">        try (Connection con = ConPool.getConnection()) {</span>
<span class="fc" id="L332">            PreparedStatement ps =</span>
<span class="fc" id="L333">                    con.prepareStatement(&quot;SELECT numeroTelefono FROM Telefono WHERE email=?&quot;);</span>
<span class="fc" id="L334">            ps.setString(1, email);</span>
<span class="fc" id="L335">            ResultSet rs = ps.executeQuery();</span>
<span class="fc bfc" id="L336" title="All 2 branches covered.">            while (rs.next()) {</span>
<span class="fc" id="L337">                telefoni.add(rs.getString(1));</span>
            }
<span class="fc" id="L339">            return telefoni;</span>
<span class="fc" id="L340">        } catch (SQLException e) {</span>
<span class="fc" id="L341">            throw new RuntimeException(e);</span>
        }
    }

    /*@ public behavior
      @   assignable \nothing;
      @   ensures \result != null;
      @   ensures (\forall int i; 0 &lt;= i &amp;&amp; i &lt; \result.size();
      @               \result.get(i) != null &amp;&amp; \result.get(i).length() == 10);
      @   signals (RuntimeException e) true;
      @*/
    public List&lt;String&gt; doRetrieveAllTelefoni() {
<span class="fc" id="L353">        List&lt;String&gt; telefoni = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L354">        try (Connection con = ConPool.getConnection()) {</span>
<span class="fc" id="L355">            PreparedStatement ps =</span>
<span class="fc" id="L356">                    con.prepareStatement(&quot;SELECT numeroTelefono FROM Telefono&quot;);</span>
<span class="fc" id="L357">            ResultSet rs = ps.executeQuery();</span>
<span class="fc bfc" id="L358" title="All 2 branches covered.">            while (rs.next()) {</span>
<span class="fc" id="L359">               telefoni.add(rs.getString(1));</span>
            }
<span class="fc" id="L361">            return telefoni;</span>
<span class="fc" id="L362">        } catch(SQLException e){</span>
<span class="fc" id="L363">            throw new RuntimeException(e);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>